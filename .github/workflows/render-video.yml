name: Render Remotion Videos

on:
  push:
    branches:
      - main
    paths:
      - 'whatsapp-bitcoin/src/**'
      - 'whatsapp-bitcoin/render.config.json'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: whatsapp-bitcoin/package-lock.json

      - name: Install dependencies
        working-directory: whatsapp-bitcoin
        run: npm ci

      - name: Render enabled compositions
        working-directory: whatsapp-bitcoin
        run: |
          # Read config and render only enabled compositions
          node -e "
            const config = require('./render.config.json');
            const { execSync } = require('child_process');

            const enabled = config.compositions.filter(c => c.enabled);

            if (enabled.length === 0) {
              console.log('No compositions enabled for rendering.');
              process.exit(0);
            }

            console.log('Rendering ' + enabled.length + ' composition(s)...\n');

            for (const comp of enabled) {
              console.log('→ Rendering: ' + comp.id + ' -> out/' + comp.output);
              execSync('npx remotion render ' + comp.id + ' out/' + comp.output, { stdio: 'inherit' });
              console.log('✓ Done: ' + comp.output + '\n');
            }
          "

      - name: Upload videos artifact
        uses: actions/upload-artifact@v4
        with:
          name: remotion-videos
          path: whatsapp-bitcoin/out/*.mp4
          if-no-files-found: warn
